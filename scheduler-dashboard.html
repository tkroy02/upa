<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduler Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .welcome-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }

        #welcomeMsg {
            font-size: 1.8rem;
            color: var(--dark);
        }

        #logoutBtn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #logoutBtn:hover {
            background-color: #d81159;
            transform: translateY(-2px);
        }

        .dashboard-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }

        .panel-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-control {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3aafd6;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d81159;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .slots-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .slot-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary);
        }

        .slot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .slot-card.past {
            border-left-color: var(--gray);
            opacity: 0.7;
        }

        .slot-card.booked {
            border-left-color: var(--success);
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .slot-date {
            font-weight: bold;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .slot-time {
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .slot-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background-color: rgba(248, 150, 30, 0.2);
            color: var(--warning);
        }

        .badge-info {
            background-color: rgba(72, 149, 239, 0.2);
            color: var(--info);
        }

        .badge-gray {
            background-color: rgba(108, 117, 125, 0.2);
            color: var(--gray);
        }

        .load-more-container {
            text-align: center;
            margin-top: 30px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--light-gray);
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-50px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-btn:hover {
            color: var(--dark);
        }

        .modal-header {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-control {
                min-width: 100%;
            }
            
            .slots-container {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            #logoutBtn {
                align-self: flex-end;
            }
        }

        .tutor-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tutor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--info);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .tutor-name {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="welcome-section">
                <div class="user-avatar" id="userAvatar">U</div>
                <h2 id="welcomeMsg">Welcome to Your Scheduler Dashboard</h2>
            </div>
            <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </header>

        <main id="roleSection">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading your dashboard...</p>
            </div>
        </main>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button id="modalCancelBtn" class="btn btn-secondary">Cancel</button>
                <button id="modalConfirmBtn" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './scheduler-firebase.js';
        import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { collection, addDoc, getDoc, doc, deleteDoc, serverTimestamp, query, where, orderBy, onSnapshot, limit, startAfter, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // DOM Elements
        const welcomeMsg = document.getElementById("welcomeMsg");
        const userAvatar = document.getElementById("userAvatar");
        const roleSection = document.getElementById("roleSection");
        const today = new Date().toISOString().split('T')[0];

        // Modal elements
        const modal = document.getElementById("myModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalMessage = document.getElementById("modalMessage");
        const modalConfirmBtn = document.getElementById("modalConfirmBtn");
        const modalCancelBtn = document.getElementById("modalCancelBtn");
        const closeBtn = document.querySelector(".close-btn");

        // State management
        let currentUser = null;
        let userData = null;
        let lastTutorSlot = null;
        let lastStudentSlot = null;

        // Modal functions
        const showModal = (title, message, onConfirm = null, confirmText = "Confirm") => {
            modalTitle.innerText = title;
            modalMessage.innerText = message;
            modalConfirmBtn.innerText = confirmText;
            
            if (onConfirm) {
                modalConfirmBtn.onclick = () => {
                    modalConfirmBtn.disabled = true;
                    modalConfirmBtn.innerHTML = '<span class="loading"></span> Processing...';
                    onConfirm();
                };
                modalConfirmBtn.style.display = 'block';
            } else {
                modalConfirmBtn.style.display = 'none';
            }
            
            modal.style.display = "flex";
            modalConfirmBtn.disabled = false;
            modalConfirmBtn.innerHTML = confirmText;
        };

        const hideModal = () => {
            modal.style.display = "none";
        };

        closeBtn.onclick = hideModal;
        modalCancelBtn.onclick = hideModal;
        window.onclick = (event) => {
            if (event.target == modal) {
                hideModal();
            }
        };

        // Utility functions
        const formatDate = (dateString) => {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        };

        const formatTime = (timeString) => {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            return `${hour % 12 || 12}:${minutes} ${hour >= 12 ? 'PM' : 'AM'}`;
        };

        const getInitials = (name) => {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        };

        const isPastSlot = (date, time) => {
            const slotDateTime = new Date(`${date}T${time}`);
            return slotDateTime < new Date();
        };

        const hoursUntilSlot = (date, time) => {
            const slotDateTime = new Date(`${date}T${time}`);
            return (slotDateTime - new Date()) / (1000 * 60 * 60);
        };

        // Firebase functions
        const fetchTutorName = async (tutorId) => {
            try {
                const docRef = doc(db, "users", tutorId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data().name : "Unknown Tutor";
            } catch (error) {
                console.error("Error fetching tutor name:", error);
                return "Unknown Tutor";
            }
        };

        // Tutor Dashboard
        const renderTutorDashboard = () => {
            roleSection.innerHTML = `
                <div class="dashboard-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><i class="fas fa-chalkboard-teacher"></i> Tutor Panel</h3>
                    </div>
                    <p>Create availability slots and manage your tutoring sessions.</p>
                    
                    <div class="form-group">
                        <h4><i class="fas fa-plus-circle"></i> Create New Availability</h4>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="slotDate">Date</label>
                                <input type="date" id="slotDate" min="${today}">
                            </div>
                            <div class="form-control">
                                <label for="startTime">Start Time</label>
                                <input type="time" id="startTime">
                            </div>
                            <div class="form-control">
                                <label for="endTime">End Time</label>
                                <input type="time" id="endTime">
                            </div>
                        </div>
                        <button id="createSlotBtn" class="btn btn-primary">
                            <i class="fas fa-calendar-plus"></i> Create Availability Slot
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><i class="fas fa-list-alt"></i> Your Upcoming Slots</h3>
                    </div>
                    <div id="upcomingSlots" class="slots-container"></div>
                    <div id="tutorEmptyState" class="empty-state" style="display: none;">
                        <i class="far fa-calendar-times"></i>
                        <p>You haven't created any availability slots yet.</p>
                    </div>
                    <div class="load-more-container">
                        <button id="loadMoreTutorSlotsBtn" class="btn btn-secondary" style="display: none;">
                            <i class="fas fa-chevron-down"></i> Load More
                        </button>
                    </div>
                </div>
            `;
            
            // Set up event listeners for tutor dashboard
            const createSlotBtn = document.getElementById("createSlotBtn");
            createSlotBtn.addEventListener("click", createAvailabilitySlot);
            
            const loadMoreBtn = document.getElementById("loadMoreTutorSlotsBtn");
            loadMoreBtn.addEventListener("click", loadMoreTutorSlots);
            
            // Load initial slots
            loadTutorSlots();
        };

        const createAvailabilitySlot = async () => {
            const createSlotBtn = document.getElementById("createSlotBtn");
            createSlotBtn.disabled = true;
            createSlotBtn.innerHTML = '<span class="loading"></span> Creating...';
            
            const date = document.getElementById("slotDate").value;
            const startTime = document.getElementById("startTime").value;
            const endTime = document.getElementById("endTime").value;
            
            if (!date || !startTime || !endTime) {
                showModal("Error", "Please fill all fields.", null);
                createSlotBtn.disabled = false;
                createSlotBtn.innerHTML = '<i class="fas fa-calendar-plus"></i> Create Availability Slot';
                return;
            }
            
            if (startTime >= endTime) {
                showModal("Error", "End time must be after start time.", null);
                createSlotBtn.disabled = false;
                createSlotBtn.innerHTML = '<i class="fas fa-calendar-plus"></i> Create Availability Slot';
                return;
            }
            
            try {
                await addDoc(collection(db, "availabilitySlots"), {
                    tutorId: auth.currentUser.uid,
                    date,
                    startTime,
                    endTime,
                    createdAt: serverTimestamp()
                });
                
                showModal("Success", "Availability slot created successfully!", () => {
                    hideModal();
                    document.getElementById("slotDate").value = '';
                    document.getElementById("startTime").value = '';
                    document.getElementById("endTime").value = '';
                });
            } catch (error) {
                console.error("Error creating slot:", error);
                showModal("Error", "Failed to create availability slot. Please try again.", null);
            } finally {
                createSlotBtn.disabled = false;
                createSlotBtn.innerHTML = '<i class="fas fa-calendar-plus"></i> Create Availability Slot';
            }
        };

        const loadTutorSlots = () => {
            const upcomingSlotsDiv = document.getElementById("upcomingSlots");
            const emptyState = document.getElementById("tutorEmptyState");
            
            const q = query(
                collection(db, "availabilitySlots"),
                where("tutorId", "==", auth.currentUser.uid),
                orderBy("date"),
                orderBy("startTime"),
                limit(10)
            );
            
            onSnapshot(q, (snapshot) => {
                upcomingSlotsDiv.innerHTML = '';
                
                if (snapshot.empty) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                snapshot.forEach(docSnap => {
                    renderTutorSlot(docSnap);
                });
                
                lastTutorSlot = snapshot.docs[snapshot.docs.length - 1];
                const loadMoreBtn = document.getElementById("loadMoreTutorSlotsBtn");
                loadMoreBtn.style.display = snapshot.size === 10 ? 'block' : 'none';
            });
        };

        const renderTutorSlot = (docSnap) => {
            const slot = docSnap.data();
            const slotId = docSnap.id;
            const upcomingSlotsDiv = document.getElementById("upcomingSlots");
            
            const slotDateTime = new Date(`${slot.date}T${slot.startTime}`);
            const isPast = slotDateTime < new Date();
            const hoursDiff = hoursUntilSlot(slot.date, slot.startTime);
            
            const slotCard = document.createElement("div");
            slotCard.classList.add("slot-card");
            if (isPast) slotCard.classList.add("past");
            
            let statusBadge = '';
            if (isPast) {
                statusBadge = '<span class="badge badge-gray">Past</span>';
            } else if (hoursDiff <= 24) {
                statusBadge = '<span class="badge badge-warning">Starting Soon</span>';
            } else {
                statusBadge = '<span class="badge badge-success">Upcoming</span>';
            }
            
            slotCard.innerHTML = `
                <div class="slot-header">
                    <div>
                        <div class="slot-date">${formatDate(slot.date)}</div>
                        <div class="slot-time">${formatTime(slot.startTime)} - ${formatTime(slot.endTime)}</div>
                    </div>
                    ${statusBadge}
                </div>
                <div class="slot-actions">
                    ${!isPast && hoursDiff > 24 ? 
                        `<button class="btn btn-danger cancel-slot-btn" data-slotid="${slotId}">
                            <i class="fas fa-times"></i> Cancel Slot
                         </button>` : 
                        `<span class="badge badge-gray">Cannot cancel within 24 hours</span>`
                    }
                </div>
            `;
            
            upcomingSlotsDiv.appendChild(slotCard);
            
            // Add event listener for cancel button
            if (!isPast && hoursDiff > 24) {
                const cancelBtn = slotCard.querySelector(".cancel-slot-btn");
                cancelBtn.addEventListener("click", () => {
                    showModal(
                        "Cancel Slot", 
                        "Are you sure you want to cancel this slot? This will also cancel any associated bookings.", 
                        () => cancelTutorSlot(slotId, cancelBtn)
                    );
                });
            }
        };

        const cancelTutorSlot = async (slotId, button) => {
            try {
                // Check for existing bookings
                const bookedSessionsQuery = query(
                    collection(db, "bookedSessions"), 
                    where("slotId", "==", slotId)
                );
                const bookedSessionsSnapshot = await getDocs(bookedSessionsQuery);
                
                // Delete all associated bookings
                const deletePromises = bookedSessionsSnapshot.docs.map(sessionDoc => 
                    deleteDoc(doc(db, "bookedSessions", sessionDoc.id))
                );
                
                await Promise.all(deletePromises);
                
                // Delete the slot itself
                await deleteDoc(doc(db, "availabilitySlots", slotId));
                
                showModal("Success", "Slot and associated bookings cancelled successfully!", hideModal);
            } catch (error) {
                console.error("Error canceling slot:", error);
                showModal("Error", "Failed to cancel slot. Please try again.", hideModal);
            }
        };

        const loadMoreTutorSlots = async () => {
            if (!lastTutorSlot) return;
            
            const loadMoreBtn = document.getElementById("loadMoreTutorSlotsBtn");
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<span class="loading"></span> Loading...';
            
            const q = query(
                collection(db, "availabilitySlots"),
                where("tutorId", "==", auth.currentUser.uid),
                orderBy("date"),
                orderBy("startTime"),
                startAfter(lastTutorSlot),
                limit(10)
            );
            
            try {
                const snapshot = await getDocs(q);
                snapshot.forEach(docSnap => {
                    renderTutorSlot(docSnap);
                });
                
                lastTutorSlot = snapshot.docs[snapshot.docs.length - 1];
                loadMoreBtn.style.display = snapshot.size === 10 ? 'block' : 'none';
            } catch (error) {
                console.error("Error loading more slots:", error);
                showModal("Error", "Failed to load more slots. Please try again.", null);
            } finally {
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Load More';
            }
        };

        // Student Dashboard
        const renderStudentDashboard = () => {
            roleSection.innerHTML = `
                <div class="dashboard-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><i class="fas fa-user-graduate"></i> Student Panel</h3>
                    </div>
                    <p>Book sessions with tutors and manage your upcoming lessons.</p>
                </div>
                
                <div class="dashboard-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><i class="fas fa-calendar-check"></i> Available Tutoring Sessions</h3>
                    </div>
                    <div id="availableSlots" class="slots-container"></div>
                    <div id="slotsEmptyState" class="empty-state" style="display: none;">
                        <i class="far fa-calendar-times"></i>
                        <p>No available tutoring sessions at this time.</p>
                    </div>
                    <div class="load-more-container">
                        <button id="loadMoreStudentSlotsBtn" class="btn btn-secondary" style="display: none;">
                            <i class="fas fa-chevron-down"></i> Load More
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><i class="fas fa-bookmark"></i> Your Booked Sessions</h3>
                    </div>
                    <div id="bookedSessions" class="slots-container"></div>
                    <div id="bookedEmptyState" class="empty-state" style="display: none;">
                        <i class="far fa-calendar-check"></i>
                        <p>You haven't booked any sessions yet.</p>
                    </div>
                </div>
            `;
            
            // Set up event listeners for student dashboard
            const loadMoreBtn = document.getElementById("loadMoreStudentSlotsBtn");
            loadMoreBtn.addEventListener("click", loadMoreStudentSlots);
            
            // Load initial data
            loadAvailableSlots();
            loadBookedSessions();
        };

        const loadAvailableSlots = async () => {
            const slotsDiv = document.getElementById("availableSlots");
            const emptyState = document.getElementById("slotsEmptyState");
            
            const q = query(
                collection(db, "availabilitySlots"),
                where("date", ">=", today),
                orderBy("date"),
                orderBy("startTime"),
                limit(10)
            );
            
            try {
                const snapshot = await getDocs(q);
                slotsDiv.innerHTML = '';
                
                if (snapshot.empty) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                for (const docSnap of snapshot.docs) {
                    await renderAvailableSlot(docSnap);
                }
                
                lastStudentSlot = snapshot.docs[snapshot.docs.length - 1];
                const loadMoreBtn = document.getElementById("loadMoreStudentSlotsBtn");
                loadMoreBtn.style.display = snapshot.size === 10 ? 'block' : 'none';
            } catch (error) {
                console.error("Error loading available slots:", error);
                slotsDiv.innerHTML = '<p>Error loading available slots. Please try again later.</p>';
            }
        };

        const renderAvailableSlot = async (docSnap) => {
            const slot = docSnap.data();
            const slotId = docSnap.id;
            const slotsDiv = document.getElementById("availableSlots");
            
            // Check if slot is already booked
            const bookingQuery = query(
                collection(db, "bookedSessions"),
                where("slotId", "==", slotId)
            );
            const bookingSnapshot = await getDocs(bookingQuery);
            
            // Skip if already booked
            if (!bookingSnapshot.empty) return;
            
            // Get tutor name
            const tutorName = await fetchTutorName(slot.tutorId);
            const tutorInitials = getInitials(tutorName);
            
            const isPast = isPastSlot(slot.date, slot.startTime);
            if (isPast) return; // Skip past slots
            
            const slotCard = document.createElement("div");
            slotCard.classList.add("slot-card");
            
            slotCard.innerHTML = `
                <div class="tutor-info">
                    <div class="tutor-avatar">${tutorInitials}</div>
                    <div class="tutor-name">${tutorName}</div>
                </div>
                <div class="slot-header">
                    <div>
                        <div class="slot-date">${formatDate(slot.date)}</div>
                        <div class="slot-time">${formatTime(slot.startTime)} - ${formatTime(slot.endTime)}</div>
                    </div>
                    <span class="badge badge-info">Available</span>
                </div>
                <div class="slot-actions">
                    <button class="btn btn-success book-slot-btn" data-slotid="${slotId}">
                        <i class="fas fa-bookmark"></i> Book Session
                    </button>
                </div>
            `;
            
            slotsDiv.appendChild(slotCard);
            
            // Add event listener for book button
            const bookBtn = slotCard.querySelector(".book-slot-btn");
            bookBtn.addEventListener("click", () => {
                showModal(
                    "Book Session", 
                    `Are you sure you want to book this session with ${tutorName} on ${formatDate(slot.date)} from ${formatTime(slot.startTime)} to ${formatTime(slot.endTime)}?`, 
                    () => bookSession(slotId, bookBtn),
                    "Book Session"
                );
            });
        };

        const bookSession = async (slotId, button) => {
            try {
                await runTransaction(db, async (transaction) => {
                    // Check if slot is still available
                    const sessionQuery = query(
                        collection(db, "bookedSessions"), 
                        where("slotId", "==", slotId)
                    );
                    const sessionSnapshot = await getDocs(sessionQuery);
                    
                    if (!sessionSnapshot.empty) {
                        throw new Error("This slot is no longer available.");
                    }
                    
                    // Book the slot
                    await addDoc(collection(db, "bookedSessions"), {
                        studentId: auth.currentUser.uid,
                        slotId: slotId,
                        bookedAt: serverTimestamp()
                    });
                });
                
                showModal("Success", "Session booked successfully!", hideModal);
            } catch (error) {
                console.error("Error booking session:", error);
                if (error.message === "This slot is no longer available.") {
                    showModal("Unavailable", "This slot was just booked by another student. Please select another slot.", hideModal);
                } else {
                    showModal("Error", "Failed to book session. Please try again.", hideModal);
                }
            }
        };

        const loadMoreStudentSlots = async () => {
            if (!lastStudentSlot) return;
            
            const loadMoreBtn = document.getElementById("loadMoreStudentSlotsBtn");
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<span class="loading"></span> Loading...';
            
            const q = query(
                collection(db, "availabilitySlots"),
                where("date", ">=", today),
                orderBy("date"),
                orderBy("startTime"),
                startAfter(lastStudentSlot),
                limit(10)
            );
            
            try {
                const snapshot = await getDocs(q);
                
                for (const docSnap of snapshot.docs) {
                    await renderAvailableSlot(docSnap);
                }
                
                lastStudentSlot = snapshot.docs[snapshot.docs.length - 1];
                loadMoreBtn.style.display = snapshot.size === 10 ? 'block' : 'none';
            } catch (error) {
                console.error("Error loading more slots:", error);
                showModal("Error", "Failed to load more slots. Please try again.", null);
            } finally {
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Load More';
            }
        };

        const loadBookedSessions = () => {
            const bookedSessionsDiv = document.getElementById("bookedSessions");
            const emptyState = document.getElementById("bookedEmptyState");
            
            const q = query(
                collection(db, "bookedSessions"),
                where("studentId", "==", auth.currentUser.uid)
            );
            
            onSnapshot(q, async (snapshot) => {
                bookedSessionsDiv.innerHTML = '';
                
                if (snapshot.empty) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                for (const docSnap of snapshot.docs) {
                    await renderBookedSession(docSnap);
                }
            });
        };

        const renderBookedSession = async (docSnap) => {
            const session = docSnap.data();
            const sessionId = docSnap.id;
            const bookedSessionsDiv = document.getElementById("bookedSessions");
            
            // Get slot details
            const slotDoc = await getDoc(doc(db, "availabilitySlots", session.slotId));
            if (!slotDoc.exists()) return;
            
            const slot = slotDoc.data();
            
            // Get tutor name
            const tutorName = await fetchTutorName(slot.tutorId);
            const tutorInitials = getInitials(tutorName);
            
            const isPast = isPastSlot(slot.date, slot.startTime);
            const hoursDiff = hoursUntilSlot(slot.date, slot.startTime);
            
            const sessionCard = document.createElement("div");
            sessionCard.classList.add("slot-card", "booked");
            
            let statusBadge = '';
            if (isPast) {
                statusBadge = '<span class="badge badge-gray">Completed</span>';
            } else if (hoursDiff <= 24) {
                statusBadge = '<span class="badge badge-warning">Starting Soon</span>';
            } else {
                statusBadge = '<span class="badge badge-success">Upcoming</span>';
            }
            
            sessionCard.innerHTML = `
                <div class="tutor-info">
                    <div class="tutor-avatar">${tutorInitials}</div>
                    <div class="tutor-name">${tutorName}</div>
                </div>
                <div class="slot-header">
                    <div>
                        <div class="slot-date">${formatDate(slot.date)}</div>
                        <div class="slot-time">${formatTime(slot.startTime)} - ${formatTime(slot.endTime)}</div>
                    </div>
                    ${statusBadge}
                </div>
                <div class="slot-actions">
                    ${!isPast && hoursDiff > 24 ? 
                        `<button class="btn btn-danger cancel-booking-btn" data-sessionid="${sessionId}">
                            <i class="fas fa-times"></i> Cancel Booking
                         </button>` : 
                        `<span class="badge badge-gray">Cannot cancel within 24 hours</span>`
                    }
                </div>
            `;
            
            bookedSessionsDiv.appendChild(sessionCard);
            
            // Add event listener for cancel button
            if (!isPast && hoursDiff > 24) {
                const cancelBtn = sessionCard.querySelector(".cancel-booking-btn");
                cancelBtn.addEventListener("click", () => {
                    showModal(
                        "Cancel Booking", 
                        "Are you sure you want to cancel this booking?", 
                        () => cancelBooking(sessionId, cancelBtn)
                    );
                });
            }
        };

        const cancelBooking = async (sessionId, button) => {
            try {
                await deleteDoc(doc(db, "bookedSessions", sessionId));
                showModal("Success", "Booking cancelled successfully!", hideModal);
            } catch (error) {
                console.error("Error cancelling booking:", error);
                showModal("Error", "Failed to cancel booking. Please try again.", hideModal);
            }
        };

        // Initialize the application
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            
            currentUser = user;
            
            try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    userData = docSnap.data();
                    welcomeMsg.textContent = `Welcome, ${userData.name}!`;
                    userAvatar.textContent = getInitials(userData.name);
                    
                    if (userData.role === "tutor") {
                        renderTutorDashboard();
                    } else {
                        renderStudentDashboard();
                    }
                } else {
                    showModal("Error", "User data not found. Please contact support.", () => {
                        signOut(auth);
                        window.location.href = "login.html";
                    });
                }
            } catch (error) {
                console.error("Failed to fetch user data:", error);
                showModal("Error", "Error loading dashboard. Please try again.", () => {
                    window.location.reload();
                });
            }
        });

        // Logout functionality
        document.getElementById("logoutBtn").addEventListener("click", async () => {
            await signOut(auth);
            window.location.href = "login.html";
        });
    </script>
</body>
</html>